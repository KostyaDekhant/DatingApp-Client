<script src="app.js?v=8"></script>

<iframe src="header.html?v=4" style="width:100%; height:50px; border:none;"></iframe>

<script>
    document.addEventListener("DOMContentLoaded", function(){
        const path = window.location.pathname;

        const match = path.match(/^\/id(\d+)$/);
        if (match) {
            const userId = match[1];
            getUserInfo(userId);
        }
        else{
            window.location.href = "/";
        }
    });

    async function getUserInfo(userId) {
        const token = localStorage.getItem('token');

        try{
            const response = await fetchWithAuth(IP+":"+PORT+"/api/users/" + userId ,{
                method: 'GET',
                headers:{
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if(!response.ok){
                console.error(`Ошибка ${response.status}`);
                if(response.status == 404){
                    let currId = localStorage.getItem('userId');
                    if(userId == currId)
                        window.top.location.href = "/";
                    else
                        window.top.location.href = "/id"+currId;
                }
                else if(response.status == 401){
                    window.top.location.href = "/";
                }
                return;
            }

            const result = await response.json();
            
            const username = document.getElementById('name');
            const height = document.getElementById('height');
            const birthday = document.getElementById('birthday');
            const age = document.getElementById('age');
            const gender = document.getElementById('gender');
            const description = document.getElementById('description');
            const last_online = document.getElementById('last_online');

            console.log("birth: ", result.birthday);
            const ageNum = getAge(result.birthday);

            username.innerText = `${result.name}, ${ageNum}`;

            // height.innerText = `Рост: ${result.height}`;
            // birthday.innerText = `День рождения: ${birthParser(result.birthday)}`; // может пригодится потом
            // gender.innerText = `Пол: ${result.gender == "Male" ? "М" : "Ж"}`;

            description.innerText = `${result.description}`;
            if(result.is_online == true){
                last_online.innerText = "Онлайн";
                last_online.style.color = "#306e31";
            }
            else {
                let strWas = result.gender == "Male" ? "был" : "была";
                last_online.innerText = `${strWas} ${dataParser(result.last_online)}`;
            }

            console.log("Server response: ", result);
            loadImage(userId);
            getUserInterest(userId);
            getUserCompanyInfo(userId);
        }
        catch(error){
            console.error("Auth error: ", error);
        }
    }
    async function getUserInterest(userId) {
        const token = localStorage.getItem('token');

        try{
            const response = await fetchWithAuth(IP+":"+PORT+"/api/users/" + userId +"/interests" ,{
                method: 'GET',
                headers:{
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            const interests = await response.json();

            const interestsСontainer = document.getElementById('interests-container');
            
            interests.forEach(interest => {
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                bubble.textContent = interest.name;
                interestsСontainer.appendChild(bubble);
            });

            //сортировка по ширине
            window.addEventListener('load', () => {
                const bubbles = Array.from(interestsСontainer.children);
                const rows = [];
                let currentTop = -1;
                let currentRow = [];

                bubbles.forEach(bubble => {
                    const top = bubble.offsetTop;
                    if (top !== currentTop) {
                    if (currentRow.length > 0) rows.push(currentRow);
                        currentRow = [bubble];
                        currentTop = top;
                    } else {
                        currentRow.push(bubble);
                    }
                });
                if (currentRow.length > 0) rows.push(currentRow);

                rows.forEach(row => {
                    const totalGap = (row.length - 1) * 10;
                    const containerWidth = interestsСontainer.clientWidth;
                    const widthPerBubble = Math.floor((containerWidth - totalGap) / row.length);

                    row.forEach(bubble => {
                    bubble.style.flex = '0 0 ' + widthPerBubble + 'px';
                    });
                });
            });

            console.log("Server response: ", interests);
        }
        catch(error){
            console.error("Auth error: ", error);
        }
    }
    async function getUserCompanyInfo(userId) {
        const token = localStorage.getItem('token');

        try{
            const response = await fetchWithAuth(IP+":"+PORT+"/api/users/" + userId +"/company_info" ,{
                method: 'GET',
                headers:{
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            const result = await response.json();

            const dolzh = document.getElementById('dolzh');
            const comp = document.getElementById('comp');
            const otdel = document.getElementById('otdel');
            const office = document.getElementById('office');

            dolzh.innerText = `${result.dolzh}`;
            comp.innerText = `${result.company_name}`;
            otdel.innerText = `${result.otdel}`;
            office.innerText = `${result.office}`;

            console.log("Server response user company info: ", result);
        }
        catch(error){
            console.error("Auth error: ", error);
        }
    }
</script>


<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Профиль</title>
    </head>
    <body>
        <div id="profile">
            <img id="photo" />
            <div id="name" style="font-size:x-large;"></div>
            <div id="last_online" style="color: rgb(99, 99, 99);"></div><br>
            <div id="interests-container" style="display: flex; flex-wrap: wrap; gap: 10px; max-width: 400px; min-width: 400px;"></div><br>
            <div id="height"></div>
            <div id="birthday"></div>
        
            <div id="gender"></div>
            <div>Описание:</div>
            <textarea id="description" value="Описание отсутствует" style="max-width: 400px; min-width: 400px; resize: none; overflow: hidden; " readonly ></textarea>
            <div>Должность:</div>
            <textarea id="dolzh" value="Должность отсутствует" style="max-width: 400px; min-width: 400px; resize: none; overflow: hidden; max-height: 30px;" readonly ></textarea>
            <div>Компания:</div>
            <textarea id="comp" value="Компания отсутствует" style="max-width: 400px; min-width: 400px; resize: none; overflow: hidden; max-height: 30px;" readonly ></textarea>
            <div>Отдел:</div>
            <textarea id="otdel" value="Отдел отсутствует" style="max-width: 400px; min-width: 400px; resize: none; overflow: hidden; max-height: 30px;" readonly ></textarea>
            <div>Офис:</div>
            <textarea id="office" value="Офис отсутствует" style="max-width: 400px; min-width: 400px; resize: none; overflow: hidden; max-height: 30px;" readonly ></textarea>
        </div>
    </body> <br><br>

    <div class="footer-wrapper">
        <iframe class="footer-frame" src="footer.html?v=5" style="width:100%; height:50px; border:0; padding:0; margin:0; display:block;" scrolling="no"></iframe>
    </div>
</html>

<style type="text/css">
#photo {
    width: 400px;
    height: 400px;
}

.oval {
    padding: 8px 16px;
    border-radius: 999px;
    background-color: #306e31;
    color: #ffffff;
    font-size: 14px;
    font: bold;
    font-family: Arial, sans-serif;
    display: inline-block;
    white-space: nowrap;
    user-select: none;
}

textarea {
    border-radius: 12px;
    border: 1 px solid #ccc;
    padding: 8px 12px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.3s;
}

html, body {
    margin: 0;
    padding: 0;
    height: 100%;
}


body {
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
}
.interests-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
.bubble {
    padding: 6px 12px;
    background-color: #2d6a2e;
    color: white;
    border-radius: 20px;
    text-align: center;
    white-space: nowrap;
    font-size: 14px;
    flex-grow: 1;
    flex-shrink: 1;
}

.row {
    display: flex;
    width: 100%;
    gap: 10px;
}

#profile{
    width: 30vw; 
    flex: 1 0 auto;
    margin: 0 auto;
}

.footer-wrapper {
    margin: 0;
    padding: 0;
    width: 100%;
}
</style>